---
- name: Ensure ssl cert  directory exists
  file: path="{{ httpd_cert_path }}"/"{{ item }}.{{ httpd_dn_suffix }}" state=directory
  with_items: sites
- name: Ensure ssl key directory exists
  file: path="{{ httpd_key_path }}"/"{{ item }}.{{ httpd_dn_suffix }}" state=directory
  with_items: sites
- name: Ensure Apache is stopped
  service:
    name: httpd
    state: stopped
- name: Generate a self-signed cert.
  sudo: yes
  command: >
     openssl req -newkey rsa:2048 -nodes -sha256 -x509 -subj "/C=US/ST=Oklahoma/L=Norman/O=University of Oklahoma/OU=Library Technology Platforms/CN={{ item }}.{{ httpd_dn_suffix }}" -days 90 -keyout "{{ httpd_key_path }}"/"{{ item }}.{{ httpd_dn_suffix }}"/privkey.pem -out "{{ httpd_cert_path }}"/"{{ item }}.{{ httpd_dn_suffix }}"/cert.pem 
  with_items: sites
- name: Create a dummy chain file
  sudo: yes
  shell: >
    echo \# > "{{ httpd_cert_path }}"/"{{ item }}.{{ httpd_dn_suffix }}"/chain.pem
  with_items: sites
- name: Ensure Apache is started
  service:
    name: httpd
    state: started
