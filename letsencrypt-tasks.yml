---
- name: Git letsencrypt.
  sudo_user: vagrant
  git: repo=https://github.com/letsencrypt/letsencrypt
       dest=/vagrant/letsencrypt/build force=yes
- name: Ensure Apache is stopped
  service:
    name: httpd
    state: stopped
- name: check for cert
  stat: path="{{ httpd_cert_path }}"/"{{ site }}"."{{ httpd_dn_suffix }}"/cert.pem
  register: cert
- name: Generate key and CSR, and get a signed cert.
  sudo: yes
  command: >
    ./letsencrypt-auto certonly --text --config-dir /vagrant/letsencrypt/etc --standalone --standalone-supported-challenges http-01 --email "{{ email }}" --agree-tos -d "{{ site }}"."{{ httpd_dn_suffix }}"
  args:
    chdir: /vagrant/letsencrypt/build
  when: cert.stat.exists == False
- name: Ensure Apache is started
  service:
    name: httpd
    state: started
