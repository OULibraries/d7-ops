---
- name: Git letsencrypt.
  sudo_user: vagrant
  git: repo=https://github.com/letsencrypt/letsencrypt
       dest=/vagrant/letsencrypt/build force=yes
- name: Ensure Apache is stopped
  service:
    name: httpd
    state: stopped
- name: Generate key and CSR, and get a signed cert.
  sudo: yes
  command: >
    stat /vagrant/letsencrypt/etc/live/"{{ item }}"."{{ httpd_dn_suffix }}" || ./letsencrypt-auto certonly --renew-by-default --text --config-dir /vagrant/letsencrypt/etc --standalone --standalone-supported-challenges http-01 --email "{{ email }}" --agree-tos -d "{{ item }}"."{{ httpd_dn_suffix }}"
  args:
    chdir: /vagrant/letsencrypt/build
  with_items: sites
- name: Ensure Apache is started
  service:
    name: httpd
    state: started
