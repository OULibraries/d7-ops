---
- name: Install packages necessary to run Drupal
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
  - net-tools
  - bind-utils
  - httpd
  - mod_ssl
  - mariadb
  - mariadb-server
  - MySQL-python
  - php
  - mod_php
  - php-mysql
  - php-ldap
  - php-pear
  - php-gd
  - php-drush-drush
- name: Start database server on boot
  service:
    name: mariadb
    state: started
    enabled: yes
- name: Run Apache httpd on boot
  service:
    name: httpd
    state: started
    enabled: yes
- name: Git d7-ops.
  sudo_user: vagrant
  git: repo=https://github.com/OULibraries/d7-ops.git
       dest=/opt/d7-ops force=yes version=dev-ansible
- name: Ensure /etc/profile.d/d7-ops.sh exists
  file: path=/etc/profile.d/d7-ops.sh state=touch mode=0644 owner=root group=root
- name: Add d7-ops scripts to path
  lineinfile: "dest=/etc/profile.d/d7-ops.sh line='export PATH=/opt/d7-ops/bin/:$PATH'"
# Equivilant to mysql_secure_installation
- name: delete anonymous MySQL server user for *
  action: mysql_user user="" host="*" state="absent"
  ignore_errors: yes
- name: delete anonymous MySQL server user for localhost
  action: mysql_user user="" state="absent"
  ignore_errors: yes
- name: remove the MySQL test database
  action: mysql_db db=test state=absent
  ignore_errors: yes
# 'localhost' needs to be the last item for idempotency, see
# http://ansible.cc/docs/modules.html#mysql-user  
- name: Change root user password on first run
  mysql_user: login_user=root
              login_password=''
              name=root
              password={{ mysql_root_password }}
              priv=*.*:ALL,GRANT
              host={{ item }}
  with_items:
    - 127.0.0.1
    - ::1
    - localhost
  ignore_errors: yes
# Apache config
- name: Include Apache config magic
  copy:
    src: ./template_init_oulib_drupal
    dest: /etc/httpd/conf.d/template_init_oulib_drupal
- name: Don't use ou.edu TLD in magic config
  command: sed -i "s/ou\.edu/vagrant.dev/" /etc/httpd/conf.d/template_init_oulib_drupal
- name: Comment out the welcome conf
  command: sed -i "s/^[^#]/#&/" /etc/httpd/conf.d/welcome.conf
- name: Give vagrant user too much permission
  command: usermod -a -G apache vagrant
- name: Set ownership of service directory
  command: chown apache:apache /srv
- name: Allow apache users to write to service directory
  command: chmod g+w /srv
