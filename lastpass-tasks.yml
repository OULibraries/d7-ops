---
- name: Check for MariaDB root credentials
  shell: >
    lpass show 'myvagrant/mariadb-root' | grep Username | cut -d ' ' -f 2 | xargs
  always_run: yes
  register: mariadb_get_root_user
  changed_when: mariadb_get_root_user.stdout != 'root'
  failed_when: "'lpass: No such file or directory' in mariadb_get_root_user.stderr"
#  notify:
#  - Set MariaDB root credentials
- name: Set MariaDB root credentials
  shell: >
    /usr/bin/lpass generate --sync=now --username=root 'myvagrant/mariadb-root' --no-symbols 32
  register: mariadb_set_root_pw
  failed_when: "'lpass: No such file or directory' in mariadb_set_root_pw.stderr"
  when: mariadb_get_root_user.stdout != 'root'
- name: Fetch MariaDB root credentials
  shell: >
    lpass show --sync=now 'myvagrant/mariadb-root' | grep Password | cut -d ' ' -f 2 | xargs
  register: mariadb_get_root_pw
  failed_when: "'lpass: No such file or directory' in mariadb_get_root_pw.stderr"
- name: Set password as fact that can be passed to target VM
  set_fact:
    mariadb_root: "{{ mariadb_get_root_pw.stdout }}"
#  when: hostvars['localhost']['mariadb_root'] is undefined
